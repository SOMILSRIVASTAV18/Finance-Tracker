{% extends "base.html" %}
{% block title %}Expenses{% endblock %}

{% block content %}
<div class="container mt-4">

<!-- ================= ADD TRANSACTION ================= -->
<div class="card mb-4">
    <div class="card-header"><b>Add Transaction</b></div>
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}

            <div class="row g-3">
                <div class="col-md-3">
                    {{ form.amount(class="form-control", placeholder="Amount") }}
                </div>

                <div class="col-md-4">
                    {{ form.description(class="form-control", placeholder="Description") }}
                </div>

                <div class="col-md-3">
                    {{ form.date(class="form-control", type="date") }}
                </div>

                <div class="col-md-2">
                    {{ form.category(class="form-select") }}
                </div>

                <div class="col-md-2 form-check mt-2">
                    {{ form.is_income(class="form-check-input") }}
                    <label class="form-check-label">Income</label>
                </div>

                <div class="col-md-2 form-check mt-2">
                    {{ form.is_recurring(class="form-check-input", id="is_recurring") }}
                    <label class="form-check-label">Recurring</label>
                </div>

                <div class="col-md-3" id="freq">
                    {{ form.recurring_frequency(class="form-select") }}
                </div>
            </div>

            <button class="btn btn-success mt-3">Save</button>
        </form>
    </div>
</div>

<!-- ================= TRANSACTIONS ================= -->
<div class="card">
<div class="card-header"><b>Transactions</b></div>
<div class="card-body table-responsive">

<table class="table table-striped align-middle">
<thead>
<tr>
    <th>Date</th>
    <th>Description</th>
    <th>Category</th>
    <th class="text-end">Amount</th>
    <th class="text-center">Actions</th>
</tr>
</thead>

<tbody>
{% for t in transactions.items %}
<tr id="row-{{ t.id }}">
    <td id="date-{{ t.id }}">{{ t.date.strftime('%Y-%m-%d') }}</td>
    <td id="desc-{{ t.id }}">{{ t.description or '-' }}</td>
    <td id="cat-{{ t.id }}">{{ t.category.name if t.category else 'Uncategorized' }}</td>

    <td id="amount-{{ t.id }}" class="text-end">
        {% if t.is_income %}
            <span class="text-success fw-bold">
                {{ t.amount|format_currency }}
            </span>
        {% else %}
            <span class="text-danger fw-bold">
                -{{ t.amount|format_currency }}
            </span>
        {% endif %}
    </td>

    <td class="text-center">
        <button class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#edit{{ t.id }}">
            Edit
        </button>

        <a href="{{ url_for('delete_expense', id=t.id) }}"
           class="btn btn-sm btn-outline-danger"
           onclick="return confirm('Delete this transaction?')">
           Delete
        </a>
    </td>
</tr>

<!-- ================= EDIT MODAL ================= -->
<div class="modal fade" id="edit{{ t.id }}" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">

<form onsubmit="updateExpense(event, {{ t.id }})">

<div class="modal-header">
    <h5 class="modal-title">Edit Transaction</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <input name="amount" value="{{ t.amount }}" class="form-control mb-2" required>
    <input name="description" value="{{ t.description }}" class="form-control mb-2">
    <input type="date" name="date" value="{{ t.date }}" class="form-control mb-2">

    <select name="category" class="form-select mb-2">
        {% for c in categories %}
        <option value="{{ c.id }}" {% if t.category_id == c.id %}selected{% endif %}>
            {{ c.name }}
        </option>
        {% endfor %}
    </select>

    <div class="form-check">
        <input class="form-check-input" type="checkbox" name="is_income"
               {% if t.is_income %}checked{% endif %}>
        <label class="form-check-label">Income</label>
    </div>
</div>

<div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    <button class="btn btn-primary">Save</button>
</div>

</form>
</div>
</div>
</div>

{% else %}
<tr>
    <td colspan="5" class="text-center text-muted">No records found</td>
</tr>
{% endfor %}
</tbody>
</table>

</div>
</div>

</div>
{% endblock %}

<!-- ================= EXTRA JS ================= -->
{% block extra_js %}
<script>
function updateExpense(e, id) {
    e.preventDefault();

    const form = e.target;
    const data = new FormData(form);

    fetch(`/expenses/edit/${id}`, {
        method: 'POST',
        body: data
    })
    .then(res => res.json())
    .then(res => {
        if (res.status === 'success') {

            document.getElementById(`desc-${id}`).innerText = form.description.value;
            document.getElementById(`date-${id}`).innerText = form.date.value;

            let amountCell = document.getElementById(`amount-${id}`);
            let amount = parseFloat(form.amount.value).toFixed(2);

            if (form.is_income.checked) {
                amountCell.innerHTML =
                    `<span class="text-success fw-bold">₹${amount}</span>`;
            } else {
                amountCell.innerHTML =
                    `<span class="text-danger fw-bold">-₹${amount}</span>`;
            }

            bootstrap.Modal.getInstance(
                form.closest('.modal')
            ).hide();
        }
    });
}

// Recurring toggle
function toggleFreq(){
    document.getElementById('freq').style.display =
        document.getElementById('is_recurring').checked ? 'block' : 'none';
}
toggleFreq();
document.getElementById('is_recurring').addEventListener('change', toggleFreq);
</script>
{% endblock %}
