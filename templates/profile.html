{% extends "base.html" %}

{% block title %}Profile - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- User Info -->
    <div class="mb-4">
        <h2>User Profile</h2>
        <p><strong>Username:</strong> {{ current_user.username }}</p>
        <p><strong>Email:</strong> {{ current_user.email }}</p>
        <p><strong>Member since:</strong> {{ current_user.created_at.strftime('%Y-%m-%d') }}</p>
    </div>

    <!-- Profile Update -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header"><strong>Update Profile Information</strong></div>
        <div class="card-body">
            <form method="POST" action="">
                {{ profile_form.hidden_tag() }}
                <div class="mb-3">
                    {{ profile_form.username.label(class="form-label") }}
                    {{ profile_form.username(class="form-control") }}
                    {% for error in profile_form.username.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    {{ profile_form.email.label(class="form-label") }}
                    {{ profile_form.email(class="form-control") }}
                    {% for error in profile_form.email.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary">{{ profile_form.submit.label.text }}</button>
            </form>
        </div>
    </div>

    <!-- Password Change -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header"><strong>Change Password</strong></div>
        <div class="card-body">
            <form method="POST" action="">
                {{ password_form.hidden_tag() }}
                <div class="mb-3">
                    {{ password_form.current_password.label(class="form-label") }}
                    {{ password_form.current_password(class="form-control") }}
                    {% for error in password_form.current_password.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    {{ password_form.new_password.label(class="form-label") }}
                    {{ password_form.new_password(class="form-control") }}
                    <small class="text-muted">
                        Password must be at least 8 characters long and include uppercase, lowercase, numbers, and special characters.
                    </small>
                    {% for error in password_form.new_password.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="mb-3">
                    {{ password_form.confirm_password.label(class="form-label") }}
                    {{ password_form.confirm_password(class="form-control") }}
                    {% for error in password_form.confirm_password.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary">{{ password_form.submit.label.text }}</button>
            </form>
        </div>
    </div>

    <!-- Data Management -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header"><strong>Data Management</strong></div>
        <div class="card-body">
            <p>Export all your financial data in CSV format:</p>
            <a href="{{ url_for('export_all_data') }}" class="btn btn-success mb-3">Export Data</a>

            <p>Permanently delete your account and all associated data:</p>
            <button id="deleteAccountBtn" class="btn btn-danger">Delete Account</button>
        </div>
    </div>

</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="deleteAccountForm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Account Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                <p>To confirm, type <strong>DELETE</strong> below:</p>
                <input type="text" id="confirmDeleteText" class="form-control" placeholder="Type DELETE to confirm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete My Account</button>
            </div>
        </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Delete account confirmation
    $('#deleteAccountBtn').click(function(e) {
        e.preventDefault();
        $('#deleteAccountModal').modal('show');
    });
    
    $('#confirmDeleteBtn').click(function() {
        const confirmText = $('#confirmDeleteText').val();
        if (confirmText === 'DELETE') {
            $('#deleteAccountForm').submit();
        } else {
            alert('Please type DELETE to confirm account deletion.');
        }
    });
});
</script>
{% endblock %}
